//
//  IncomingCallPresenter.swift
//  Pods
//
//  Created by Slam on 9/4/23.
//  Copyright (c) 2023 ___ORGANIZATIONNAME___. All rights reserved.
//
//  This file was generated by the 🐍 VIPER generator
//

import Foundation
import RxSwift
import LiveKitClient

final class IncomingCallPresenter {

    // MARK: - Private properties -
    
    fileprivate lazy var disposeBag: DisposeBag = .init()

    private unowned let view: IncomingCallViewInterface
    
    fileprivate let contactInteractor: ContactByUserIdInteractor
    fileprivate let contactService: ContactDBService
    fileprivate let callService: CallServiceClientProtocol

    fileprivate let userId: String
    
    private let wireframe: IncomingCallWireframeInterface
    fileprivate var callStatus: CallStatus
    private var isDismissing: Bool = false
    // MARK: - Lifecycle -

    init(userId: String,
         callInformation: CallStatus,
         view: IncomingCallViewInterface,
         contactService: ContactDBService,
         callService: CallServiceClientProtocol,
         wireframe: IncomingCallWireframeInterface,
         contactInteractor: ContactByUserIdInteractor) {
        self.view = view
        self.userId = userId
        self.wireframe = wireframe
        self.contactService = contactService
        self.callService = callService
        self.callStatus = callInformation
        self.contactInteractor = contactInteractor
        RoomManager.shared.roomManagerDelegate = self
        RoomManager.shared.addRoomDelegate(self)
    }

}

// MARK: - Extensions -

extension IncomingCallPresenter: IncomingCallPresenterInterface {
    
    func getLocalParticipant() -> LocalParticipant? {
        RoomManager.shared.room.localParticipant
    }
    
    func getRemoteParticipant() -> RemoteParticipant? {
        RoomManager.shared.room.remoteParticipants.first?.value
    }
    
    func getIsConnected() -> Bool {
        RoomManager.shared.room.connectionState == .connected
    }
    
    func getCallStatus() -> CallStatus {
        callStatus
    }
    
    func reject() {
        UltraVoIPManager.shared.endCall()
    }
    
    func cancel() {
        UltraVoIPManager.shared.endCall()
    }
    
    func answerCall() {
//        RoomManager.shared.connectRoom(with: callStatus.callInfo)
    }
    
    func viewDidLoad() {
        connectToRoom()
    }
    
    func createCall() {
        callService.create(.with({
            $0.users = [userId]
            $0.video = callStatus.isVideoCall
        }), callOptions: .default())
        .response
        .whenComplete({ [weak self] result in
            guard let self else { return }
            switch result {
            case let .success(response):
                let info = CallOutging(
                    video: callStatus.isVideoCall,
                    host: response.host,
                    room: response.room,
                    sender: userId,
                    accessToken: response.accessToken
                )
                callStatus = .outcoming(info)
                connectToRoom()
            case let .failure(error):
                PP.error(error.localizedDescription)
            }
        })
    }
  
    private func connectToRoom() {
        switch callStatus {
        case let .prepeare(client):
            displayClientInfo(sender: client.sender)
        case let .incoming(client),
            let .outcoming(client):
            displayClientInfo(sender: client.sender)
        }
        guard RoomManager.shared.room.connectionState != .connected else {
            self.view.updateForStartCall()
            self.view.setMicEnabled(RoomManager.shared.room.localParticipant?.isMicrophoneEnabled() ?? false)
            self.view.setCameraEnabled(RoomManager.shared.room.localParticipant?.isCameraEnabled() ?? false)
            self.view.setSpeakerButtonEnabled(AudioManager.shared.preferSpeakerOutput)
            self.updateParticipantTrack(for: RoomManager.shared.room)
            return
        }
        AudioManager.shared.preferSpeakerOutput = callStatus.isVideoCall
        if case .outcoming = callStatus {
            switch callStatus {
            case let .incoming(client),
                let .outcoming(client):
                UltraVoIPManager.shared.startOutgoingCall(callInfo: client)
            default:
                break
            }
        }
    }
    
    private func displayClientInfo(sender: String) {
        if let contact = contactService.contact(id: sender) {
            self.view.dispay(view: contact)
        } else {
//            self.contactInteractor
//                .executeSingle(params: self.callStatus.callInfo.sender)
//                .flatMap({ self.contactService.save(contact: DBContact(from: $0, chatId: )).map({ $0 }) })
//                .observe(on: ConcurrentDispatchQueueScheduler(qos: .background))
//                .subscribe(on: MainScheduler.asyncInstance)
//                .subscribe(onSuccess: { [weak self] contact in
//                    guard let `self` = self, let contact = self.contactService.contact(id: callStatus.callInfo.sender) else { return }
//                    self.view.dispay(view: contact)
//                })
//                .disposed(by: disposeBag)
        }
    }
    
    func didTapBack() {
        guard !isDismissing else {
            return
        }
        isDismissing = true
        DispatchQueue.main.async { [weak self] in
            guard let self = self else {
                return
            }
            RoomManager.shared.roomManagerDelegate = nil
            RoomManager.shared.removeRoomDelegate(self)
            self.wireframe.dissmiss {
                UltraVoIPManager.shared.showCallTopView()
            }
        }
    }
    
    func setMicrophone(enabled: Bool) {
        PP.debug("[CALL] Set microphone enabled - \(enabled)")
        RoomManager.shared.room.localParticipant?.setMicrophone(enabled: enabled)
    }
    
    func setCamera(enabled: Bool) {
        PP.debug("[CALL] Set camera enabled - \(enabled)")
        RoomManager.shared.room.localParticipant?.setCamera(enabled: enabled)
    }
    
}

extension IncomingCallPresenter: RoomDelegate {
    
    func room(_ room: Room, didUpdate connectionState: ConnectionState, oldValue: ConnectionState) {
        PP.debug("[CALL] connection state - \(connectionState.desctiption) for room - \(room.sid ?? "")")
        switch connectionState {
        case .reconnecting, .connecting:
            DispatchQueue.main.async { [weak self] in
                self?.view.showConnectionStatus(connectionState.desctiption)
            }
        default:
            break
        }
    }
    
    func room(_ room: Room, participantDidJoin participant: RemoteParticipant) {
        PP.debug("[CALL] participant - \(participant.name) did join for room - \(room.sid ?? "")")
        if case .outcoming = callStatus {
            RoomManager.shared.startCallTimer()
        }
        view.updateForStartCall()
    }
    
    func room(_ room: Room, localParticipant: LocalParticipant, didPublish publication: LocalTrackPublication) {
        guard publication.track is VideoTrack else { return }
        updateParticipantTrack(for: room)
    }
 
    func room(_ room: Room, participant: RemoteParticipant, didSubscribe publication: RemoteTrackPublication, track: Track) {
        guard track is VideoTrack else { return }
        updateParticipantTrack(for: room)
    }
    
    func room(_ room: Room, participant: Participant, didUpdate publication: TrackPublication, muted: Bool) {
        guard publication.track is VideoTrack else { return }
        updateParticipantTrack(for: room)
    }
    
    private func updateParticipantTrack(for room: Room) {
        let remote = room.remoteParticipants.first?.value
        let local = room.localParticipant
        view.updateParticipantTrack(remote: remote, local: local)
    }
    
    private func dismiss() {
        guard !isDismissing else {
            return
        }
        isDismissing = true
        DispatchQueue.main.async { [weak self] in
            guard let self = self else {
                return
            }
            RoomManager.shared.roomManagerDelegate = nil
            RoomManager.shared.removeRoomDelegate(self)
            self.wireframe.dissmiss { }
        }
    }

}

extension IncomingCallPresenter: RoomManagerDelegate {
    func didConnectToRoom() {
        DispatchQueue.main.async { [weak self] in
            guard let self else { return }
            if case .incoming = callStatus {
                RoomManager.shared.startCallTimer()
            }
            self.view.showConnectedRoom(with: self.callStatus)
        }
    }
    
    func didFailToConnectToRoom() {
        dismiss()
    }
    
    func didDisconnectFromRoom() {
        dismiss()
    }
}
